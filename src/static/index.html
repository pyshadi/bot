<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Chat Application</title>
    <!-- Prism.js CSS and JavaScript for syntax highlighting -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/themes/prism.min.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-python.min.js"></script>

    <style>
      /* Existing chat styles */
      body {
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        background-color: #f5f5f5;
      }
      .chat-container {
        width: 100%;
        max-width: 600px;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        background-color: white;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
      }
      .messages {
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 10px;
        padding: 10px;
      }
      .message-container {
        display: flex;
        align-items: left;
        flex-direction: column; /* Stack items vertically */
        margin: 8px 0;
      }
      .message {
        padding: 10px;
        border-radius: 8px;
        max-width: 100%;
      }

      .user-message {
        background-color: #106258;
        color: white;
        margin-left: auto;
        margin-right: 8px;
      }
      .ai-message {
        background-color: #e9ecef;
        color: black;
        margin-right: auto;
      }
      .input-container {
        display: flex;
      }
      #inputBox {
        flex-grow: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-right: 8px;
      }
      #sendButton {
        padding: 10px 20px;
        background-color: #106258;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      #sendButton:hover {
        background-color: #106258;
      }
      .edit-button {
        background-color: transparent;
        border: none;
        color: #106258;
        cursor: pointer;
        font-size: 12px;
        margin-right: 5px;
      }
      .edit-button:hover {
        color: #399489;
      }
      .editable-input {
        padding: 8px;
        font-size: 14px;
        width: 100%;
        box-sizing: border-box;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      /* Container for code blocks */
      .code-block {
        margin: 5px 0; /* Minimal margin between code blocks */
        padding: 0; /* Remove padding from the container */
        background-color: #f5f5f5;
        border-radius: 5px;
      }

      /* Code block styling within the pre tag */
      .code-block pre {
        padding: 6px; /* Small padding inside the code for readability */
        margin: 0; /* Remove margin from the pre tag */
        background-color: #f5f5f5;
        border-radius: 5px;
        overflow-x: auto;
      }

      /* Styling for code */
      .code-block pre code {
        font-family: "Courier New", Courier, monospace;
        font-size: 14px;
        color: #333;
        white-space: pre-wrap; /* Wrap text to avoid horizontal scrolling */
        word-break: break-word; /* Break long words to avoid overflow */
      }

      /* Minimal margin for text block to reduce spacing between text and code blocks */
      .text-block {
        margin: 5px 0;
      }
    </style>
  </head>

  <body>
    <div class="chat-container">
      <h1>Chat with llama3</h1>
      <div class="messages" id="messages"></div>
      <div class="input-container">
        <input
          type="text"
          id="inputBox"
          placeholder="Type your message here..."
        />
        <button id="sendButton" onclick="sendMessage()">Send</button>
      </div>
    </div>

    <script>
      let editingMessageElement = null; // Track the element being edited

      function sendMessage() {
        const input = document.getElementById("inputBox");
        const user_input = input.value.trim();

        if (!user_input) return;

        if (editingMessageElement) {
          updateUserMessage(user_input);
          removeSubsequentMessages(editingMessageElement);

          let aiMessageElement = editingMessageElement.nextElementSibling;
          if (
            !aiMessageElement ||
            !aiMessageElement.classList.contains("ai-message")
          ) {
            aiMessageElement = displayMessage("...", "ai-message");
          }
          fetchAIResponse(user_input, aiMessageElement);
          editingMessageElement = null;
        } else {
          const userMessageContainer = displayMessage(
            user_input,
            "user-message",
            true
          );
          const aiMessageElement = displayMessage("...", "ai-message");
          fetchAIResponse(user_input, aiMessageElement);
        }
        input.value = "";
      }

      function fetchAIResponse(user_input, aiMessageElement) {
        fetch("http://127.0.0.1:8000/chat/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ model: "llama3", user_input: user_input }),
        })
          .then((response) => response.json())
          .then((data) => {
            aiMessageElement.innerHTML = ""; // Clear previous content
            formatResponse(data.response).forEach((element) => {
              aiMessageElement.appendChild(element);
            });
            Prism.highlightAll(); // Apply syntax highlighting
          })
          .catch((error) => {
            console.error("Error:", error);
            aiMessageElement.textContent =
              "There was an error processing your request.";
          });
      }

      function formatResponse(response) {
        const codeBlockRegex = /```([\s\S]*?)```/g;
        const parts = response.split(codeBlockRegex);
        const elements = [];

        parts.forEach((part, index) => {
          const wrapper = document.createElement("div");
          wrapper.style.display = "block"; // Ensure each part is on its own line

          if (index % 2 === 0) {
            // Text section
            wrapper.textContent = part;
            wrapper.className = "text-block";
          } else {
            // Code section
            const codeContainer = document.createElement("pre");
            const codeElement = document.createElement("code");
            codeElement.className = "language-python";
            codeElement.innerHTML = escapeHTML(part);
            codeContainer.appendChild(codeElement);
            wrapper.appendChild(codeContainer);
            wrapper.className = "code-block";
          }
          elements.push(wrapper);
        });

        return elements;
      }

      function escapeHTML(str) {
        return str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function displayMessage(content, className, isUser = false) {
        const messagesList = document.getElementById("messages");

        const messageContainer = document.createElement("div");
        messageContainer.className = "message-container";

        if (isUser) {
          const userContainer = document.createElement("div");
          userContainer.className = "user-message-container";

          const message = document.createElement("div");
          message.className = `message user-message`;
          message.textContent = content;

          const editButton = document.createElement("button");
          editButton.className = "edit-button";
          editButton.textContent = "Edit";
          editButton.onclick = () => enableEditing(messageContainer);

          userContainer.appendChild(editButton);
          userContainer.appendChild(message);

          messageContainer.appendChild(userContainer);
        } else {
          const message = document.createElement("div");
          message.className = `message ${className}`;
          formatResponse(content).forEach((element) => {
            message.appendChild(element);
          });
          messageContainer.appendChild(message);
        }

        messagesList.appendChild(messageContainer);
        messagesList.scrollTop = messagesList.scrollHeight;

        return messageContainer;
      }

      function enableEditing(messageContainer) {
        editingMessageElement = messageContainer;
        const messageContent = messageContainer.querySelector(".user-message");
        const currentText = messageContent.textContent;

        const input = document.createElement("input");
        input.type = "text";
        input.value = currentText;
        input.className = "editable-input";
        input.onblur = () => saveEdit(input);
        input.onkeypress = (e) => {
          if (e.key === "Enter") saveEdit(input);
        };

        messageContent.replaceWith(input);
        input.focus();
      }

      function saveEdit(inputElement) {
        const newText = inputElement.value.trim();

        if (newText && editingMessageElement) {
          updateUserMessage(newText);
          removeSubsequentMessages(editingMessageElement);

          let aiMessage = editingMessageElement.nextElementSibling;
          if (!aiMessage || !aiMessage.classList.contains("ai-message")) {
            aiMessage = displayMessage("...", "ai-message");
          }

          fetchAIResponse(newText, aiMessage);
        }

        editingMessageElement = null;
      }

      function updateUserMessage(newText) {
        const inputElement =
          editingMessageElement.querySelector(".editable-input");

        const messageContent = document.createElement("div");
        messageContent.className = "message user-message";
        messageContent.textContent = newText;

        inputElement.replaceWith(messageContent);
      }

      function removeSubsequentMessages(messageContainer) {
        const messagesList = document.getElementById("messages");
        let currentMessage = messageContainer.nextElementSibling;

        while (currentMessage) {
          const nextMessage = currentMessage.nextElementSibling;
          messagesList.removeChild(currentMessage);
          currentMessage = nextMessage;
        }
      }
    </script>
  </body>
</html>
